/** 
 * Simple Table Math v0.2.3
 * @author Sandro Ducceschi
 * @url https://eatcodeplay.dev
 */
var x=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var j=Object.prototype.hasOwnProperty;var G=(m,u)=>{for(var e in u)x(m,e,{get:u[e],enumerable:!0})},B=(m,u,e,t)=>{if(u&&typeof u=="object"||typeof u=="function")for(let s of $(u))!j.call(m,s)&&s!==e&&x(m,s,{get:()=>u[s],enumerable:!(t=_(u,s))||t.enumerable});return m};var J=m=>B(x({},"__esModule",{value:!0}),m);var W={};G(W,{default:()=>C});module.exports=J(W);var i=require("obsidian"),Q={fractions:2,locale:null,styleLastRow:!0},C=class extends i.Plugin{constructor(){super(...arguments);this.keymapHandlers=[];this.preventProcessing=!1;this.forceProcessing=!1}async onload(){let e=this.app,t=e.workspace;await this.loadSettings(),this.addSettingTab(new P(this.app,this)),this.debouncedProcessing=(0,i.debounce)(this.process.bind(this),250),t.onLayoutReady(()=>{this.registerEvent(t.on("layout-change",this.debouncedProcessing)),this.registerEvent(t.on("editor-change",this.debouncedProcessing)),this.registerEvent(t.on("editor-menu",this.handleEditorMenuEvent.bind(this))),this.keymapHandlers=[e.scope.register(null,"Tab",this.debouncedProcessing),e.scope.register(null,"ArrowLeft",this.debouncedProcessing),e.scope.register(null,"ArrowUp",this.debouncedProcessing),e.scope.register(null,"ArrowRight",this.debouncedProcessing),e.scope.register(null,"ArrowDown",this.debouncedProcessing)],this.registerDomEvent(document,"click",this.debouncedProcessing),this.registerDomEvent(document,"keydown",this.handleKeyDownEvent.bind(this))}),this.registerEvent(t.on("file-open",()=>{this.forceProcessing=!0,this.debouncedProcessing()}))}onunload(){this.keymapHandlers.forEach(e=>{this.app.scope.unregister(e)})}process(){var e;if(!this.preventProcessing){this.preventProcessing=!0;let t=this.app.workspace.getActiveViewOfType(i.MarkdownView),n=((t==null?void 0:t.getMode())||null)==="preview",o=[],y=n?"div.el-table > table":"div.markdown-rendered table.table-editor";(n||this.forceProcessing)&&(o=Array.from(document.querySelectorAll(y))||[],this.forceProcessing=!1);let H=(e=document.activeElement)==null?void 0:e.closest(y);H&&(this.forceProcessing=!0,o=[H]);let k=["stm-row",...this.settings.styleLastRow?[]:["off"]];o.forEach(z=>{let A=Array.from(z.querySelectorAll("tr"));A.forEach((V,N)=>{let D=Array.from(V.children);D.forEach((r,S)=>{var q,K,R,O;let f=(this.extractCellContent(r).trim().toLowerCase()||"").match(/^([a-z]{3})([<^])(?:(\d+)(?::(\d+))?)?([a-z]{2,4})?$/i),I=this.isDocumentActiveElementChildOf(r);if(f&&!I){let h=f[1].toLowerCase(),p=f[2],T=f[3],F=f[4],U=((q=f[5])==null?void 0:q.toUpperCase())||null,l=[],E=T?parseInt(T,10)-1:0;isNaN(E)&&(E=0);let b=F?parseInt(F,10)-1:-1;if(isNaN(b)&&(b=-1),p==="^"){let a=Math.max(0,E),c=b!==-1?b:N-1,v=Math.min(c,N-1);if(a<=v)for(let g=a;g<=v;g++){let L=(R=(K=A[g])==null?void 0:K.children)==null?void 0:R[S],M=this.extractCellContent(L,!0),w=this.extractNumber(M);w!==null&&l.push(w)}}else if(p==="<"){let a=Math.max(0,E),c=b!==-1?b:S-1,v=Math.min(c,S-1);if(a<=v)for(let g=a;g<=v;g++){let L=D[g],M=this.extractCellContent(L,!0),w=this.extractNumber(M);w!==null&&l.push(w)}}let d=null;if(h==="sum")d=l.reduce((a,c)=>a+c,0);else if(h==="avg"&&l.length>0)d=l.reduce((a,c)=>a+c,0)/l.length;else if(h==="min")d=l.length>0?Math.min(...l):0;else if(h==="max")d=l.length>0?Math.max(...l):0;else if(h==="sub")d=l.length>0?l.reduce((a,c)=>a-c):0;else if(h==="mul")d=l.length>1?l.reduce((a,c)=>a*c,1):0;else if(h==="div"&&l.length>0&&(d=l[0],l.length>1))for(let a=1;a<l.length;a++)d=d/l[a];if(d!==null){let a=r.querySelector("div.stm-value");if(n&&(a=r,r.classList.add("stm-value")),a||(a=document.createElement("div"),a.classList.add("stm-value"),r.prepend(a)),a){r.classList.add("stm-cell"),r.tabIndex=-1,(O=r.closest("tr"))==null||O.classList.add(...k);let c=(0,i.getLanguage)();a.textContent=d.toLocaleString(this.settings.locale||c,{style:U?"currency":"decimal",currency:U||void 0,minimumFractionDigits:this.settings.fractions,maximumFractionDigits:this.settings.fractions})}}}else if(!I&&r.classList.contains("stm-cell")){let h=r.querySelector("div.stm-value");if(h){r.removeChild(h);let p=r.closest("tr");p&&p.querySelectorAll(".stm-value").length===0&&p.classList.remove(...k)}}})})})}this.preventProcessing=!1}async loadSettings(){this.settings=Object.assign({},Q,await this.loadData())}async saveSettings(){await this.saveData(this.settings),document.querySelectorAll("tr.stm-row").forEach(t=>{this.settings.styleLastRow?t.classList.remove("off"):t.classList.add("off")})}showNotice(e,t=null,s=1e3){let n=(0,i.sanitizeHTMLToDom)(`<span class="stm-notice">${e}</span>`);if(t){let o=(0,i.getIcon)(t);o&&n.prepend(o)}new i.Notice(n,s)}handleEditorMenuEvent(e){var n;let t=(n=document.activeElement)==null?void 0:n.closest("td.stm-cell"),s=t==null?void 0:t.querySelector(".stm-value");s&&e.addItem(o=>{o.setTitle("Copy calculated value").setIcon("square-equal").onClick(async()=>{navigator.clipboard.writeText(s.textContent||""),this.showNotice("Copied!","copy-check")})})}handleKeyDownEvent(e){var t;if(this.isCopyShortcut(e)){this.process();let s=(t=document.activeElement)==null?void 0:t.closest("td.stm-cell, th.stm-cell");if(s){let n=s.querySelector(".stm-value");n&&setTimeout(()=>{navigator.clipboard.writeText(n.textContent||""),this.showNotice("Copied!","copy-check")},25)}}}extractCellContent(e,t=!1){if(!e)return"";let s=e.querySelector(".table-cell-wrapper");if(t){let o=e.querySelector(".stm-value");o&&(s=o)}let n=s||e;return(n==null?void 0:n.textContent)||""}extractNumber(e){if(!e)return null;let t=e.match(/-?\d+(?:[.,'’`\u202f]\d{3})*(?:[.,]\d+)?/);if(!t)return null;let s=t[0].replace(/['’`\u202f]/g,""),n=s.lastIndexOf(","),o=s.lastIndexOf(".");n>o?s=s.replace(/\./g,"").replace(",","."):s=s.replace(/,/g,"");let y=parseFloat(s);return isNaN(y)?null:y}isDocumentActiveElementChildOf(e){return!document.activeElement||!e?!1:e.contains(document.activeElement)}isCopyShortcut(e){return i.Platform.isMacOS?e.metaKey&&e.key==="c"&&!e.altKey&&!e.shiftKey:e.ctrlKey&&e.key==="c"&&!e.altKey&&!e.shiftKey}},P=class extends i.PluginSettingTab{constructor(e,t){super(e,t);this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new i.Setting(e).setName("Fractions").setDesc("Maximum number of decimal places to display.").addText(s=>s.setPlaceholder("Enter a number").setValue(this.plugin.settings.fractions.toString()).onChange(async n=>{this.plugin.settings.fractions=parseInt(n,10)||0,await this.plugin.saveSettings()}));let t=(0,i.getLanguage)();new i.Setting(e).setName("Number formatting").setDesc((0,i.sanitizeHTMLToDom)(`Enter a locale code (language tag like en, en-US, or de-CH) to customize how numbers are formatted, (e.g., decimal separators, thousands separators).<br/><br/>If left empty, the current Obsidian app language ("${t}") will be used for number formatting.<br/><a href="https://en.wikipedia.org/wiki/Language_code" target="_blank">Learn more about language codes</a>`)).addText(s=>s.setPlaceholder("e.g.: en, en-US, de-CH").setValue(this.plugin.settings.locale||"").onChange(async n=>{this.plugin.settings.locale=n===""?null:n,await this.plugin.saveSettings()})),new i.Setting(e).setName("Highlight last row calculations").setDesc((0,i.sanitizeHTMLToDom)('Enable styling for the last row in tables that contain calculations.<br/><a href="https://github.com/eatcodeplay/obsidian-simple-table-math#css-look--feel" target="_blank">Learn more about styling the results</a>')).addToggle(s=>s.setValue(this.plugin.settings.styleLastRow).onChange(async n=>{this.plugin.settings.styleLastRow=n,await this.plugin.saveSettings()}))}};

/* nosourcemap */